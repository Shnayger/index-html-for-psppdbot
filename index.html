<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞ –£–ö–ó</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            overflow: hidden;
            background: black;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* –ë–ª–æ–∫ –∫–∞–º–µ—Ä—ã */
        #video-container {
            position: relative;
            width: 100%;
            flex: 1;
            overflow: hidden;
            min-height: 0;
            background: #000;
        }
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ */
        #qr-reader {
            width: 100%;
            height: 100%;
            position: relative;
        }
        /* –£–≥–æ–ª–∫–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
        .corner {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            top: 50%;
            left: 50%;
        }
        .corner-tl {
            transform: translate(-120px, -120px);
            width: 40px;
            height: 40px;
            border-left: 4px solid white;
            border-top: 4px solid white;
        }
        .corner-tr {
            transform: translate(80px, -120px);
            width: 40px;
            height: 40px;
            border-right: 4px solid white;
            border-top: 4px solid white;
        }
        .corner-bl {
            transform: translate(-120px, 80px);
            width: 40px;
            height: 40px;
            border-left: 4px solid white;
            border-bottom: 4px solid white;
        }
        .corner-br {
            transform: translate(80px, 80px);
            width: 40px;
            height: 40px;
            border-right: 4px solid white;
            border-bottom: 4px solid white;
        }
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
        #scan-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, 160px);
            width: 260px;
            text-align: center;
            color: white;
            font-size: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        /* –ö–æ–Ω—Å–æ–ª—å –¥–ª—è –ª–æ–≥–æ–≤ */
        #log-console {
            position: fixed;
            bottom: 140px;
            left: 10px;
            right: 10px;
            height: 100px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px;
            font-size: 10px;
            font-family: monospace;
            color: #0f0;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }
        .log-entry {
            margin-bottom: 2px;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.2;
        }
        .log-entry.error {
            color: #ff4444;
        }
        .log-entry.success {
            color: #00ff9d;
        }
        .log-entry.warning {
            color: #ffff00;
        }

        /* –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
        #results-container {
            background: rgba(25, 25, 25, 0.95);
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            padding: 12px;
            min-height: 120px;
            max-height: 140px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #results {
            font-size: 14px;
            line-height: 1.5;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .result-item {
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }
        .result-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        .datamatrix-result {
            color: #00ff9d;
        }
        .barcode-result {
            color: #4da6ff;
        }
        .empty-results {
            color: #888;
            font-style: italic;
            text-align: center;
            padding: 20px 0;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –¢–†–ò –ö–ù–û–ü–ö–ò */
        #controls {
            display: flex;
            gap: 6px;
            padding: 10px;
            background: rgba(20, 20, 20, 0.95);
            position: relative;
            z-index: 100;
        }
        .control-btn {
            flex: 1;
            padding: 12px 4px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 55px;
        }
        .control-btn:active {
            transform: scale(0.98);
        }
        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        #log-btn {
            background: linear-gradient(135deg, #6c757d, #5c636a);
        }
        #clear-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        #finish-btn {
            background: linear-gradient(135deg, #28a745, #218838);
        }
        .btn-icon {
            font-size: 18px;
        }
        .btn-text {
            font-size: 11px;
            text-align: center;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        #results-container::-webkit-scrollbar,
        #log-console::-webkit-scrollbar {
            width: 4px;
        }
        #results-container::-webkit-scrollbar-track,
        #log-console::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        #results-container::-webkit-scrollbar-thumb,
        #log-console::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- –ö–æ–Ω—Å–æ–ª—å –¥–ª—è –ª–æ–≥–æ–≤ -->
    <div id="log-console"></div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="app">
        <!-- –ë–ª–æ–∫ –∫–∞–º–µ—Ä—ã -->
        <div id="video-container">
            <div id="qr-reader"></div>
            <!-- –£–≥–æ–ª–∫–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞ -->
            <div class="corner corner-tl"></div>
            <div class="corner corner-tr"></div>
            <div class="corner corner-bl"></div>
            <div class="corner corner-br"></div>
            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ —á—Ç–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å -->
            <div id="scan-hint">–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ DataMatrix</div>
        </div>
        
        <!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="results-container">
            <div id="results">
                <div class="empty-results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>
            </div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –¢–†–ò –ö–ù–û–ü–ö–ò -->
        <div id="controls">
            <button id="log-btn" class="control-btn">
                <div class="btn-icon">üìã</div>
                <div class="btn-text">–õ–æ–≥</div>
            </button>
            <button id="clear-btn" class="control-btn">
                <div class="btn-icon">üóëÔ∏è</div>
                <div class="btn-text">–û—á–∏—Å—Ç–∏—Ç—å</div>
            </button>
            <button id="finish-btn" class="control-btn">
                <div class="btn-icon">‚úÖ</div>
                <div class="btn-text">–ó–∞–≤–µ—Ä—à–∏—Ç—å</div>
            </button>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–π audio –¥–ª—è –∑–≤—É–∫–æ–≤ -->
    <audio id="scan-success-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const logConsole = document.getElementById('log-console');
        const logBtn = document.getElementById('log-btn');
        
        function logToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const shortTime = timestamp.split(' ')[1];
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${shortTime}] ${message}`;
            
            logConsole.appendChild(logEntry);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
            while (logConsole.children.length > 20) {
                logConsole.removeChild(logConsole.firstChild);
            }
            
            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            setTimeout(() => {
                logConsole.scrollTop = logConsole.scrollHeight;
            }, 10);
            
            // –¢–∞–∫–∂–µ –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
            if (type !== 'debug') { // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—Ç–ª–∞–¥–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
                console.log(`[${timestamp}] ${message}`);
            }
        }
        
        logBtn.addEventListener('click', () => {
            logConsole.style.display = logConsole.style.display === 'none' ? 'block' : 'none';
            logBtn.style.background = logConsole.style.display === 'block' 
                ? 'linear-gradient(135deg, #4a5568, #2d3748)' 
                : 'linear-gradient(135deg, #6c757d, #5c636a)';
        });

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let step = 'datamatrix';
        let scanCount = 0;
        const resultsEl = document.getElementById('results');
        const resultsContainer = document.getElementById('results-container');
        const scanHintEl = document.getElementById('scan-hint');
        
        // –ó–≤—É–∫–∏
        const successSound = document.getElementById('scan-success-sound');
        
        function playSound(type) {
            try {
                if (type === 'success' && successSound) {
                    successSound.currentTime = 0;
                    successSound.play();
                }
            } catch (e) {
                // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∑–≤—É–∫–∞
            }
        }

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const config = {
            fps: 10,
            qrbox: {
                width: 250,
                height: 250
            },
            rememberLastUsedCamera: true,
            formatsToSupport: [
                Html5QrcodeSupportedFormats.DATA_MATRIX,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.QR_CODE
            ]
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
        const html5QrCode = new Html5Qrcode("qr-reader");
        let isScanning = false;
        let lastScannedCode = '';
        let lastScanTime = 0;

        // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ DataMatrix
        function analyzeDataMatrix(code) {
            const length = code.length;
            
            // 1. –£–ö–ó - 30 —Å–∏–º–≤–æ–ª–æ–≤
            if (length === 30) {
                logToConsole('–û–±–Ω–∞—Ä—É–∂–µ–Ω –£–ö–ó (30 —Å–∏–º–≤–æ–ª–æ–≤)', 'success');
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏ —Å–µ—Ä–∏—é
                const number = code.substring(18, 27);
                const series = code.substring(27, 30);
                
                return {
                    type: 'ukz',
                    display: `–£–ö–ó: ${code}`,
                    details: `–ù–æ–º–µ—Ä: ${number}, –°–µ—Ä–∏—è: ${series}`,
                    number: number,
                    series: series
                };
            }
            
            // 2. –°–ò - 35 —Å–∏–º–≤–æ–ª–æ–≤
            else if (length === 35) {
                logToConsole('–û–±–Ω–∞—Ä—É–∂–µ–Ω –°–ò (35 —Å–∏–º–≤–æ–ª–æ–≤)', 'success');
                
                const gtin = code.substring(3, 16);
                
                if (/^\d{13}$/.test(gtin)) {
                    return {
                        type: 'si',
                        display: `–°–ò: ${code}`,
                        details: `GTIN: ${gtin}`,
                        gtin: gtin
                    };
                } else {
                    return {
                        type: 'si',
                        display: `–°–ò: ${code}`,
                        details: `–î–ª–∏–Ω–∞: 35 —Å–∏–º–≤–æ–ª–æ–≤`,
                        raw: code
                    };
                }
            }
            
            // 3. –°—Ç–∏–∫–µ—Ä—ã - 22 —Ü–∏—Ñ—Ä—ã
            else if (length === 22 && /^\d{22}$/.test(code)) {
                const id = code.substring(0, 9);
                const gtin = code.substring(9, 22);
                return {
                    type: 'stickers',
                    display: `–°—Ç–∏–∫–µ—Ä: ${code}`,
                    details: `ID: ${id}, GTIN: ${gtin}`,
                    id: id,
                    gtin: gtin
                };
            }
            
            // 4. –õ—é–±–æ–π –¥—Ä—É–≥–æ–π DataMatrix
            else if (length >= 20 && length <= 50) {
                logToConsole(`DataMatrix (${length} —Å–∏–º–≤–æ–ª–æ–≤)`, 'info');
                return {
                    type: 'datamatrix',
                    display: `DataMatrix: ${code}`,
                    details: `–î–ª–∏–Ω–∞: ${length} —Å–∏–º–≤–æ–ª–æ–≤`,
                    raw: code
                };
            }
            
            return null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function addResult(text, type, details = '') {
            const emptyMessage = resultsEl.querySelector('.empty-results');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            const item = document.createElement('div');
            item.className = `result-item ${type}-result`;
            
            const number = document.createElement('strong');
            number.textContent = `${scanCount + 1}. `;
            
            const icon = document.createElement('span');
            icon.textContent = type === 'datamatrix' ? 'üì¶ ' : 'üõí ';
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            
            if (details) {
                const detailsSpan = document.createElement('div');
                detailsSpan.style.fontSize = '12px';
                detailsSpan.style.color = '#aaa';
                detailsSpan.style.marginTop = '2px';
                detailsSpan.textContent = details;
                item.appendChild(detailsSpan);
            }
            
            item.appendChild(number);
            item.appendChild(icon);
            item.appendChild(textSpan);
            resultsEl.appendChild(item);
            
            scanCount++;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            setTimeout(() => {
                resultsContainer.scrollTop = resultsContainer.scrollHeight;
            }, 50);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
        function updateScanHint() {
            if (step === 'datamatrix') {
                scanHintEl.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ DataMatrix';
                scanHintEl.style.color = '#00ff9d';
                scanHintEl.style.borderColor = 'rgba(0, 255, 157, 0.4)';
            } else {
                scanHintEl.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥';
                scanHintEl.style.color = '#4da6ff';
                scanHintEl.style.borderColor = 'rgba(77, 166, 255, 0.4)';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function onScanSuccess(decodedText) {
            const code = decodedText.trim();
            const now = Date.now();
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
            if (code === lastScannedCode && (now - lastScanTime) < 800) {
                return;
            }
            
            lastScannedCode = code;
            lastScanTime = now;
            
            logToConsole('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
            logToConsole(`–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${code}`, 'info');
            logToConsole(`–î–ª–∏–Ω–∞: ${code.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
            
            let isValid = false;
            let result = null;

            if (step === 'datamatrix') {
                if (code.length >= 20 && code.length <= 50) {
                    result = analyzeDataMatrix(code);
                    
                    if (result) {
                        isValid = true;
                        addResult(result.display, 'datamatrix', result.details);
                        step = 'barcode';
                        playSound('success');
                        showScanFeedback(true, 'datamatrix');
                        logToConsole(`‚úÖ –ü—Ä–∏–Ω—è—Ç: ${result.type.toUpperCase()}`, 'success');
                    } else {
                        logToConsole(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø DataMatrix`, 'error');
                    }
                } else {
                    logToConsole(`‚ùå –ù–µ DataMatrix (–¥–ª–∏–Ω–∞ ${code.length})`, 'error');
                }
            } 
            else if (step === 'barcode') {
                if (/^\d{13}$/.test(code)) {
                    isValid = true;
                    addResult(`–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${code}`, 'barcode', `EAN-13: ${code}`);
                    step = 'datamatrix';
                    playSound('success');
                    showScanFeedback(true, 'barcode');
                    logToConsole(`‚úÖ –ü—Ä–∏–Ω—è—Ç: –®–¢–†–ò–•-–ö–û–î`, 'success');
                }
                else if (/^\d{8}$/.test(code)) {
                    isValid = true;
                    addResult(`–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${code}`, 'barcode', `EAN-8: ${code}`);
                    step = 'datamatrix';
                    playSound('success');
                    showScanFeedback(true, 'barcode');
                    logToConsole(`‚úÖ –ü—Ä–∏–Ω—è—Ç: –®–¢–†–ò–•-–ö–û–î`, 'success');
                }
                else if (/^[A-Za-z0-9]{8,20}$/.test(code)) {
                    isValid = true;
                    addResult(`–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${code}`, 'barcode');
                    step = 'datamatrix';
                    playSound('success');
                    showScanFeedback(true, 'barcode');
                    logToConsole(`‚úÖ –ü—Ä–∏–Ω—è—Ç: –®–¢–†–ò–•-–ö–û–î`, 'success');
                }
                else {
                    logToConsole(`‚ùå –ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫–∞–∫ —à—Ç—Ä–∏—Ö-–∫–æ–¥`, 'error');
                }
            }
            
            if (isValid) {
                updateScanHint();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - –ò–ì–ù–û–†–ò–†–£–ï–ú –ü–û–í–¢–û–†–ù–´–ï –û–®–ò–ë–ö–ò
        let lastError = '';
        let errorCount = 0;
        let lastErrorTime = 0;
        
        function onScanError(errorMessage) {
            const now = Date.now();
            
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—à–∏–±–∫—É "no barcode or qr code detected"
            if (errorMessage.includes('no barcode or qr code detected')) {
                return; // –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —ç—Ç—É –æ—à–∏–±–∫—É
            }
            
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º NotFoundException
            if (errorMessage.includes('NotFoundException')) {
                return;
            }
            
            // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ - –ª–æ–≥–∏—Ä—É–µ–º –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 5 —Å–µ–∫—É–Ω–¥
            if (errorMessage === lastError && (now - lastErrorTime) < 5000) {
                errorCount++;
                return;
            }
            
            // –õ–æ–≥–∏—Ä—É–µ–º –Ω–æ–≤—É—é –æ—à–∏–±–∫—É
            if (errorMessage !== lastError || errorCount > 10) {
                logToConsole(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞: ${errorMessage}`, 'warning');
                lastError = errorMessage;
                lastErrorTime = now;
                errorCount = 0;
            }
        }

        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        function showScanFeedback(success, type) {
            const color = success ? (type === 'datamatrix' ? '#00ff9d' : '#4da6ff') : '#ff4444';
            
            scanHintEl.style.background = `rgba(${type === 'datamatrix' ? '0,80,0' : '0,0,80'}, 0.9)`;
            scanHintEl.style.boxShadow = `0 4px 15px ${color}40`;
            
            setTimeout(() => {
                scanHintEl.style.background = 'rgba(0, 0, 0, 0.8)';
                scanHintEl.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
            }, 300);
        }

        // –ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function startScanner() {
            if (isScanning) return;
            
            logToConsole('–ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞...', 'info');
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
            ).then(() => {
                isScanning = true;
                logToConsole('‚úÖ –°–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω', 'success');
            }).catch(err => {
                logToConsole(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${err.message || err}`, 'error');
                scanHintEl.textContent = '–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã';
                scanHintEl.style.color = '#ff4444';
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('clear-btn').onclick = () => {
            resultsEl.innerHTML = '<div class="empty-results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>';
            step = 'datamatrix';
            scanCount = 0;
            lastScannedCode = '';
            updateScanHint();
            logToConsole('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã', 'info');
        };
        
        document.getElementById('finish-btn').onclick = () => {
            if (isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    logToConsole('–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
                    if (window.Telegram && Telegram.WebApp) {
                        Telegram.WebApp.close();
                    }
                }).catch(err => {
                    if (window.Telegram && Telegram.WebApp) {
                        Telegram.WebApp.close();
                    }
                });
            } else {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.close();
                }
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateScanHint();
        startScanner();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥
        setTimeout(() => {
            logConsole.style.display = 'block';
            logBtn.style.background = 'linear-gradient(135deg, #4a5568, #2d3748)';
            logToConsole('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞', 'success');
            logToConsole('DataMatrix ‚Üí —à—Ç—Ä–∏—Ö-–∫–æ–¥ ‚Üí DataMatrix ‚Üí ...', 'info');
        }, 1000);

        // CSS –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        const style = document.createElement('style');
        style.textContent = `
            #qr-reader__dashboard_section,
            #qr-reader__camera_permission_button,
            #qr-reader__scan_region,
            #qr-reader__dashboard,
            #qr-reader__camera_selection {
                display: none !important;
            }
            
            #qr-reader video {
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
            }
            
            #qr-reader > * {
                border: none !important;
                outline: none !important;
                box-shadow: none !important;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
